#!/usr/bin/make -f

## BEGIN_MAKE_VARS
## NOTE: These variables are re-generated for each version
aprver               := 1
__isa_bits           := 64
__isa_name           := x86
__sourcedir          := 
_bindir              := /usr/bin
_datadir             := /usr/share
_defaultdocdir       := /usr/share/doc
_docdir              := /usr/share/doc
_exec_prefix         := /usr
_includedir          := /usr/include
_infodir             := /usr/share/info
_lib                 := lib64
_libdir              := /usr/lib64
_libexecdir          := /usr/libexec
_localstatedir       := /var/cpanel
_mandir              := /usr/share/man
_prefix              := /usr
_root_bindir         := /usr/bin
_root_datadir        := /usr/share
_root_exec_prefix    := /usr
_root_includedir     := /usr/include
_root_infodir        := /usr/share/info
_root_initddir       := /etc/rc.d/init.d
_root_libdir         := /usr/lib64
_root_libexecdir     := /usr/libexec
_root_localstatedir  := /var/cpanel
_root_mandir         := /usr/share/man
_root_prefix         := /usr
_root_sbindir        := /usr/sbin
_root_sharedstatedir := /usr/com
_root_sysconfdir     := /etc
_sbindir             := /usr/sbin
_scl_prefix          := /opt/cpanel
_scl_root            := 
_sysconfdir          := /etc
apuver               := 1
buildroot            := /usr/src/packages/BUILD
cpanel_version       := 1.6.1.9
dbdep                := libdb-devel
ea_apr_dir           := /opt/cpanel/ea-apr16
ea_apr_name          := ea-apr16
ea_openssl_ver       := 1.1.1d-1
ix86                 := i386
ns_name              := ea
pkg                  := 
pkg_base             := apr-util
pkg_name             := ea-apr-util
pkgname              := ea-apr-util
prefix_bin           := /opt/cpanel/ea-apr16/bin
prefix_dir           := /opt/cpanel/ea-apr16
prefix_inc           := /opt/cpanel/ea-apr16/include
prefix_lib           := /opt/cpanel/ea-apr16/lib64
prefix_name          := ea-apr16-util
release              := 9
release_prefix       := 9
scl                  := ea-apr-util
scl_prefix           := 
version              := 1.6.1
with_freetds         := 1
DEB_INSTALL_ROOT     := /usr/src/packages/BUILD/debian/tmp
DEB_SOURCE_ROOT      := /usr/src/packages/BUILD/debian/SOURCES_FROM_SPEC
SOURCE1              := $(DEB_SOURCE_ROOT)/macros.ea-apu
## END_MAKE_VARS

%:
	echo "EXECING $@"
	dh $@

override_dh_auto_configure:
	autoheader && autoconf -f
	# A fragile autoconf test which fails if the code trips
	# any other warning; force correct result for OpenLDAP:
	export ac_cv_ldap_set_rebind_proc_style=three
	./configure --prefix=$(prefix_dir) --libdir=$(prefix_lib) --with-apr=$(ea_apr_dir) --includedir=$(prefix_inc)/apr-$(apuver) --with-ldap=ldap_r --without-gdbm --with-sqlite3 --with-pgsql --with-odbc --with-berkeley-db --without-sqlite2 --with-crypto --with-openssl --with-nss --with-mysql
	make 

override_dh_auto_install:
	rm -rf $(DEB_INSTALL_ROOT)
	make install DESTDIR=$(DEB_INSTALL_ROOT)
	# Unpackaged files; remove the static libaprutil
	rm -f $(DEB_INSTALL_ROOT)$(prefix_lib)/aprutil.exp \
	      $(DEB_INSTALL_ROOT)$(prefix_lib)/libapr*.a
	# And remove the reference to the static libaprutil from the .la
	# file.
	sed -i '/^old_library/s,libapr.*\.a,,' \
	      $(DEB_INSTALL_ROOT)$(prefix_lib)/libapr*.la
	# Remove unnecessary exports from dependency_libs
	sed -ri '/^dependency_libs/{s,-l(pq|sqlite[0-9]|rt|dl|uuid) ,,g}' \
	      $(DEB_INSTALL_ROOT)$(prefix_lib)/libapr*.la
	# Trim libtool DSO cruft
	rm -f $(DEB_INSTALL_ROOT)$(prefix_lib)/apr-util-$(apuver)/*.*a
	# Use our correctly-named package files within pkgconfig
	sed -ri '/pkg-config/{s/apr-util-$(apuver)/$(prefix_name)-$(apuver)/}' \
	    $(DEB_INSTALL_ROOT)$(prefix_bin)/apu-$(apuver)-config
	ls -R /usr/src/packages/BUILD
	mkdir -p $(DEB_INSTALL_ROOT)/docs
	cp /usr/src/packages/BUILD/CHANGES $(DEB_INSTALL_ROOT)/docs
	cp /usr/src/packages/BUILD/LICENSE $(DEB_INSTALL_ROOT)/docs
	cp /usr/src/packages/BUILD/NOTICE $(DEB_INSTALL_ROOT)/docs
	# Set up the macros file
	install -d -m 755 $(DEB_INSTALL_ROOT)/etc/rpm
	sed -e 's/@APU_NAME@/%{prefix_name}/g' \
    	-e 's/@APU_VER@/%{apuver}/g' \
    	-e 's,@APU_DIR@,%{prefix_dir},g' \
    	-e 's/@NAMESPACE@/%{ns_name}_/g' \
    	$(SOURCE1) > $(DEB_INSTALL_ROOT)/etc/rpm/macros.$(pkg_name)
	ls -R $(DEB_INSTALL_ROOT)
	ls /usr/src/packages/BUILD/debian/tmp/opt/cpanel/ea-apr16/lib64/pkgconfig
	mkdir -p $(DEB_INSTALL_ROOT)/usr/share/pkgconfig
	mv $(DEB_INSTALL_ROOT)$(prefix_lib)/pkgconfig/apr-util-$(aprver).pc $(DEB_INSTALL_ROOT)/usr/share/pkgconfig/$(prefix_name)-$(aprver).pc

override_dh_auto_test:
	echo "Ignoring Tests"
	/bin/true

